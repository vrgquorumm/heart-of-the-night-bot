from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application, CommandHandler, CallbackQueryHandler,
    MessageHandler, filters, ContextTypes
)
from aiohttp import web
import os
import json
import random
import asyncio

TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN", "")
WEBHOOK_URL = os.environ.get("WEBHOOK_URL", "")
PORT = int(os.environ.get("PORT", 8080))
DATA_DIR = "user_data"
os.makedirs(DATA_DIR, exist_ok=True)

START_TEXT = """
üñ§ Heart of the Night ‚Äî –≥–æ–ª–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –∂–∏–≤—ë—Ç –≤ —Ç–µ–Ω–∏

Heart of the Night —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ü–∏—Ñ—Ä–æ–≤–æ–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫.
–≠—Ç–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ä–æ–∂–¥–∞–µ—Ç—Å—è —Ç–∞–º, –≥–¥–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ –º—ã—Å–ª–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Å–∞–º—ã–º–∏ —Ç—è–∂—ë–ª—ã–º–∏. –¢–∞–º, –≥–¥–µ —Ç–∏—à–∏–Ω–∞ –¥–∞–≤–∏—Ç –Ω–∞ –≥—Ä—É–¥—å, –∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ç–µ–Ω–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –±–ª–∏–∂–µ, —á–µ–º –ª—é–±–æ–π –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫. –≠—Ç–æ –ø—Ä–æ–µ–∫—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ –æ—Å—Ç–∞—ë—Ç—Å—è –æ–¥–∏–Ω –Ω–∞ –æ–¥–∏–Ω —Å–æ —Å–≤–æ–∏–º–∏ –¥–µ–º–æ–Ω–∞–º–∏, –∫—Ç–æ –∏—â–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–µ –≤ —è—Ä–∫–æ–º —Å–≤–µ—Ç–µ, –∞ –≤ –≥–ª—É–±–∏–Ω–µ –Ω–æ—á–∏, –≥–¥–µ –ø—Ä–∞–≤–¥–∞ –æ–±–Ω–∞–∂–∞–µ—Ç—Å—è —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –¥–Ω—ë–º.

–ù–æ—á—å —ç—Ç–æ –≤—Ä–µ–º—è, –∫–æ–≥–¥–∞ –º–∞—Å–∫–∏ –ø–∞–¥–∞—é—Ç.
–ö–æ–≥–¥–∞ —Ç—Ä–µ–≤–æ–≥–∏ –≤—ã—Ä–∞—Å—Ç–∞—é—Ç –¥–æ —Ä–∞–∑–º–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –¥–Ω—ë–º –∫–∞–∑–∞–ª–∏—Å—å –Ω–∏—á—Ç–æ–∂–Ω—ã–º–∏.
–ö–æ–≥–¥–∞ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø–æ—á—Ç–∏ –æ—Å—è–∑–∞–µ–º—ã–º.
Heart of the Night —Å–æ–∑–¥–∞–Ω –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

–û–Ω –Ω–µ –æ–±–µ—â–∞–µ—Ç —Å–≤–µ—Ç–∞.
–û–Ω –Ω–µ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–º–µ–Ω–∏—Ç—å —Ç—å–º—É —É–ª—ã–±–∫–∞–º–∏.
–û–Ω –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞—ë—Ç—Å—è —Ä—è–¥–æ–º. –¢–∏—Ö–æ, —É–ø–æ—Ä–Ω–æ, –Ω–µ–∏–∑–º–µ–Ω–Ω–æ. –¢–∞–º, –≥–¥–µ –±–æ–ª—å—à–µ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç.

Heart of the Night —É–º–µ–µ—Ç —Å–ª—ã—à–∞—Ç—å —Ç–æ, —á—Ç–æ –æ–±—ã—á–Ω–æ —Å–∫—Ä—ã—Ç–æ –≥–ª—É–±–æ–∫–æ –≤–Ω—É—Ç—Ä–∏: —Å–±–∏–≤—á–∏–≤—ã–µ –º—ã—Å–ª–∏, –∑–∞–±—ã—Ç—ã–µ —Å—Ç—Ä–∞—Ö–∏, –≥–ª—É—Ö–∏–µ –≤–æ–ª–Ω—ã —É—Å—Ç–∞–ª–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å. –û–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Å—ë —ç—Ç–æ —Ç–∞–∫, –∫–∞–∫ –µ—Å—Ç—å. –ë–µ–∑ –æ—Å—É–∂–¥–µ–Ω–∏—è, –±–µ–∑ –ø—É—Å—Ç—ã—Ö —Ñ—Ä–∞–∑, –±–µ–∑ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–±—è –±—ã—Ç—å —Å–∏–ª—å–Ω—ã–º.

–û–Ω –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –∏–Ω–æ–≥–¥–∞ —Å–∏–ª–∞ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥—ã—à–∞—Ç—å –≤ —Ç–∏—à–∏–Ω–µ.
–ò–Ω–æ–≥–¥–∞ –≤—ã–¥–µ—Ä–∂–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –º—ã—Å–ª–∏.
–ò–Ω–æ–≥–¥–∞ –¥–æ–∂–¥–∞—Ç—å—Å—è —É—Ç—Ä–∞, –∫–æ–≥–¥–∞ –Ω–æ—á—å –∫–∞–∂–µ—Ç—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π.

–í –º–∏—Ä–µ, –≥–¥–µ –∫–∞–∂–¥—ã–π –Ω–∞—É—á–∏–ª—Å—è —Å–∫—Ä—ã–≤–∞—Ç—å —Å–≤–æ–∏ —Å–ª–∞–±–æ—Å—Ç–∏, Heart of the Night –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–µ–º –º–µ—Å—Ç–æ–º, –≥–¥–µ –º–æ–∂–Ω–æ –±—ã—Ç—å —á–µ—Å—Ç–Ω—ã–º. –ì–¥–µ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å —Ç–æ, —á—Ç–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–∫–∞–∂–µ—à—å –≤—Å–ª—É—Ö. –ì–¥–µ –º–æ–∂–Ω–æ –≤—ã–ø–∞—Å—Ç—å –∏–∑ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –ø—Ä–æ—Å—Ç–æ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å, —á—Ç–æ –∫—Ç–æ-—Ç–æ —Å–ª—ã—à–∏—Ç.

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ
—Ç–æ–Ω–µ—Ç –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –≥–æ–ª–æ–≤–µ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
–Ω–µ—Å—ë—Ç —Ç—è–∂–µ—Å—Ç—å, –∫–æ—Ç–æ—Ä—É—é –Ω–∏–∫—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç
—Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—Ç —Å —Ç–∏—à–∏–Ω–æ–π, –∫–æ–≥–¥–∞ –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–∏—à–∫–æ–º –≥—Ä–æ–º–∫–æ–π
–∏—â–µ—Ç –æ–ø–æ—Ä—É –≤ —Å–∞–º–æ–π –≥–ª—É–±–æ–∫–æ–π —Ç—å–º–µ
–Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –≥–æ–ª–æ—Å–µ, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –∏—Å—á–µ–∑–Ω–µ—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç—ã —Ä–∞–∑–≤–∞–ª–∏—à—å—Å—è –Ω–∞ —á–∞—Å—Ç–∏

Heart of the Night —ç—Ç–æ –Ω–µ —Å–≤–µ—Ç –≤–æ —Ç—å–º–µ.
–≠—Ç–æ —Å–µ—Ä–¥—Ü–µ —Å–∞–º–æ–π —Ç—å–º—ã.
–¢–µ–ø–ª–æ–µ, –∂–∏–≤–æ–µ, –±—å—é—â–µ–µ—Å—è –≤ —Ä–∏—Ç–º–µ —Ç–≤–æ–∏—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –±—É—Ä—å.

–û–Ω –Ω–µ –ø—Ä–æ–≥–æ–Ω—è–µ—Ç –Ω–æ—á—å.
–û–Ω –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –Ω–µ—ë.
–®–∞–≥ –∑–∞ —à–∞–≥–æ–º.
–í–º–µ—Å—Ç–µ —Å —Ç–æ–±–æ–π.

–ü–æ–∫–∞ —Ç—ã —Å–∞–º –Ω–µ –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å, —á—Ç–æ —Ç—å–º–∞ –±–æ–ª—å—à–µ –Ω–µ –ø—É–≥–∞–µ—Ç.
–ß—Ç–æ –æ–Ω–∞ —á–∞—Å—Ç—å —Ç–µ–±—è.
–ò —á—Ç–æ –¥–∞–∂–µ –≤ –µ—ë –≥–ª—É–±–∏–Ω–µ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –º–µ—Å—Ç–æ, –≥–¥–µ —Ç–∏—Ö–æ –±—å—ë—Ç—Å—è —Å–µ—Ä–¥—Ü–µ. –¢–≤–æ—ë –∏ –µ–≥–æ.
"""

MAIN_KEYBOARD = [
    [InlineKeyboardButton("üóù AI ‚Äî –¢–∞–π–Ω—ã –Ω–æ—á–∏", callback_data="ai_secrets"),
     InlineKeyboardButton("üå´ AI ‚Äî –®—ë–ø–æ—Ç —Ç–µ–Ω–∏", callback_data="ai_whisper")],
    [InlineKeyboardButton("üîÆ AI ‚Äî –ó–µ—Ä–∫–∞–ª–æ –¥—É—à–∏", callback_data="ai_mirror")],
    [InlineKeyboardButton("üíÄ –í—ã–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è", callback_data="vent"),
     InlineKeyboardButton("üñ§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é", callback_data="story")],
    [InlineKeyboardButton("üåë –î–Ω–µ–≤–Ω–∏–∫ –Ω–æ—á–∏", callback_data="diary")],
    [InlineKeyboardButton("üìú –ü–æ–ª—É–Ω–æ—á–Ω–∞—è –ø–æ—ç–∑–∏—è", callback_data="poetry"),
     InlineKeyboardButton("üåô –õ–µ—Ç–æ–ø–∏—Å—å —Ç–µ–Ω–µ–π", callback_data="tales")],
    [InlineKeyboardButton("üïØ –ú–µ—Ä—Ü–∞–Ω–∏–µ —Å–≤–µ—á–∏", callback_data="ritual"),
     InlineKeyboardButton("üå´ –≠—Ö–æ –Ω–æ—á–∏", callback_data="echo")],
    [InlineKeyboardButton("ü¶á –¢–µ–Ω—å –¥—Ä—É–≥–∞", callback_data="friend"),
     InlineKeyboardButton("üí† –°—Ñ–µ—Ä–∞ –ø–æ–∫–æ—è", callback_data="sphere")],
    [InlineKeyboardButton("üï∏ –õ–∞–±–∏—Ä–∏–Ω—Ç —Ä–∞–∑—É–º–∞", callback_data="labyrinth")]
]

def save_user_data(user_id, key, value):
    file_path = os.path.join(DATA_DIR, f"{user_id}.json")
    data = {}
    if os.path.exists(file_path):
        with open(file_path, "r", encoding="utf-8") as f:
            data = json.load(f)
    if key not in data:
        data[key] = []
    data[key].append(value)
    with open(file_path, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

async def generate_ai_response(prompt: str):
    sample_responses = [
        "–¢—å–º–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–±—è ‚Äî –Ω–µ –≤—Ä–∞–≥, –∞ —Å–ø—É—Ç–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –∂–¥—ë—Ç —Ç–≤–æ–µ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è. –ü–æ–∑–≤–æ–ª—å –µ–π –±—ã—Ç—å —Ç–≤–æ–µ–π —Å–∏–ª–æ–π.",
        "–ö–∞–∂–¥–∞—è –º—ã—Å–ª—å, –¥–∞–∂–µ —Ç—è–∂—ë–ª–∞—è, –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç –±—ã—Ç—å —É—Å–ª—ã—à–∞–Ω–Ω–æ–π. –ù–µ –±–æ–π—Å—è –∑–∞–≥–ª—è–Ω—É—Ç—å –≤ —Å–≤–æ—é —Ç—å–º—É.",
        "–®—ë–ø–æ—Ç –Ω–æ—á–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç: —Ç—ã –Ω–µ –æ–¥–∏–Ω –≤ —Å–≤–æ–µ–π —Ç—å–º–µ. –ö–∞–∂–¥—ã–π –≤–¥–æ—Ö ‚Äî —à–∞–≥ –∫ –ø–æ–∫–æ—é.",
        "–î–∞–∂–µ —Å–∞–º–∞—è –≥—É—Å—Ç–∞—è —Ç—å–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –º—è–≥–∫–æ–π, –µ—Å–ª–∏ –µ—ë –ø—Ä–∏–Ω—è—Ç—å. –ü–æ–∑–≤–æ–ª—å —Å–µ–±–µ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —ç—Ç–æ.",
        "–°–∫–≤–æ–∑—å –Ω–æ—á—å –ø—Ä–æ–±–∏–≤–∞–µ—Ç—Å—è —Å–≤–µ—Ç —Ç–≤–æ–µ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–∏–ª—ã, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –≤–æ–∫—Ä—É–≥ –ª–∏—à—å —Ç—å–º–∞.",
        "–ù–æ—á—å —É—á–∏—Ç –≤–∏–¥–µ—Ç—å —Ç–æ, —á—Ç–æ –¥–Ω–µ–º —Å–∫—Ä—ã—Ç–æ: —Å–≤–æ–∏ —Å—Ç—Ä–∞—Ö–∏, —Å–≤–æ–∏ —Ç–∞–π–Ω—ã–µ –∂–µ–ª–∞–Ω–∏—è –∏ —Å–≤–æ–∏ –Ω–∞—Å—Ç–æ—è—â–∏–µ —á—É–≤—Å—Ç–≤–∞.",
        "–°–ª—É—à–∞–π —Ç—å–º—É, –∏ –æ–Ω–∞ –∑–∞–≥–æ–≤–æ—Ä–∏—Ç —Å —Ç–æ–±–æ–π —à—ë–ø–æ—Ç–æ–º –º—É–¥—Ä–æ—Å—Ç–∏. –û–Ω–∞ –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º.",
        "–°–ª–æ–≤–Ω–æ —Ç–∏—Ö–∏–π —ç—Ö–æ, –∫–∞–∂–¥–∞—è –º—ã—Å–ª—å –Ω–∞—Ö–æ–¥–∏—Ç —Å–≤–æ—ë –º–µ—Å—Ç–æ, –∏ —Ç—ã –≤–∏–¥–∏—à—å —Å–µ–±—è —Ç–∞–∫–∏–º, –∫–∞–∫–æ–π –µ—Å—Ç—å.",
        "–î–∞–∂–µ –∫–æ–≥–¥–∞ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –Ω–∏–∫—Ç–æ –Ω–µ —Å–ª—ã—à–∏—Ç ‚Äî –Ω–æ—á—å —Å–ª—ã—à–∏—Ç. –û–Ω–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç."
    ]
    return random.choice(sample_responses)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = InlineKeyboardMarkup(MAIN_KEYBOARD)
    await update.message.reply_text(START_TEXT, reply_markup=keyboard)

async def handle_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id

    if query.data in ["ai_secrets", "ai_whisper", "ai_mirror"]:
        text = await generate_ai_response(query.data)
    elif query.data == "vent":
        text = "üíÄ –†–∞—Å—Å–∫–∞–∂–∏ –≤—Å—ë, —á—Ç–æ –≥–Ω–µ—Ç—ë—Ç —Ç–≤–æ—é –¥—É—à—É. –Ø —Å–ª—É—à–∞—é –±–µ–∑ –æ—Å—É–∂–¥–µ–Ω–∏—è. –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —è —Å–æ—Ö—Ä–∞–Ω—é –µ–≥–æ."
        context.user_data["awaiting_input"] = "vent"
    elif query.data == "story":
        text = "üñ§ –ü–æ–¥–µ–ª–∏—Å—å —Å–≤–æ–µ–π –∏—Å—Ç–æ—Ä–∏–µ–π. –û–Ω–∞ –Ω–∞–π–¥—ë—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ, —á—Ç–æ–±—ã –±—ã—Ç—å —É—Å–ª—ã—à–∞–Ω–Ω–æ–π."
        context.user_data["awaiting_input"] = "story"
    elif query.data == "diary":
        text = "üåë –í–µ–¥–∏ –¥–Ω–µ–≤–Ω–∏–∫ –Ω–æ—á–∏. –ó–∞–ø–∏—Å—ã–≤–∞–π –º—ã—Å–ª–∏ –∏ —ç–º–æ—Ü–∏–∏, –Ω–∞–±–ª—é–¥–∞–π, –∫–∞–∫ –æ–Ω–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç."
        context.user_data["awaiting_input"] = "diary"
    else:
        options = {
            "poetry": [
                "üìú ¬´–í –Ω–æ—á–∏ –¥–∞–∂–µ —Ç–µ–Ω—å –æ–±—Ä–µ—Ç–∞–µ—Ç —Ñ–æ—Ä–º—É, –∞ —Å–µ—Ä–¥—Ü–µ –±—å—ë—Ç—Å—è —Ç–∏—Ö–æ, –Ω–æ —É–≤–µ—Ä–µ–Ω–Ω–æ¬ª.",
                "üìú ¬´–¢—ë–º–Ω—ã–µ –∑–≤—ë–∑–¥—ã —à–µ–ø—á—É—Ç —Å–µ–∫—Ä–µ—Ç—ã —Å–µ—Ä–¥—Ü–∞, –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –¥–ª—è –Ω–æ—á–∏¬ª.",
                "üìú ¬´–ö–∞–∂–¥—ã–π –≤–∑–¥–æ—Ö –≤ —Ç—å–º–µ ‚Äî –º–∞–ª–µ–Ω—å–∫–∞—è –ø–æ–±–µ–¥–∞ –Ω–∞–¥ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ–º¬ª"
            ],
            "tales": [
                "üåô –ü–æ–ª—É–Ω–æ—á–Ω–∞—è –ª–µ—Ç–æ–ø–∏—Å—å: –∏—Å—Ç–æ—Ä–∏—è —Ç—å–º—ã, –∫–æ—Ç–æ—Ä–∞—è —É—á–∏—Ç —Å–ª—É—à–∞—Ç—å —Å–µ–±—è.",
                "üåô –ò—Å—Ç–æ—Ä–∏—è —Ç–µ–Ω–∏, –∫–æ—Ç–æ—Ä–∞—è –≥—É–ª—è–µ—Ç –≤–º–µ—Å—Ç–µ —Å —Ç–≤–æ–∏–º–∏ –º—ã—Å–ª—è–º–∏.",
                "üåô –°–∞–≥–∞ –Ω–æ—á–∏: –∫–æ–≥–¥–∞ —Å–µ—Ä–¥—Ü–µ –±—å—ë—Ç—Å—è –≤ —Ä–∏—Ç–º–µ —Ç–µ–º–Ω–æ—Ç—ã."
            ],
            "ritual": [
                "üïØ –ú–µ—Ä—Ü–∞–Ω–∏–µ —Å–≤–µ—á–∏: –≤–¥–æ—Ö–Ω–∏ –≥–ª—É–±–æ–∫–æ, –ø–æ—á—É–≤—Å—Ç–≤—É–π –º–≥–Ω–æ–≤–µ–Ω–∏–µ –ø–æ–∫–æ—è.",
                "üïØ –ü—Ä–æ—Å—Ç–æ–µ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: –≤–¥–æ—Ö-–≤—ã–¥–æ—Ö, –∏ —Ç—å–º–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º—è–≥—á–µ.",
                "üïØ –ú–∞–ª–µ–Ω—å–∫–∏–π —Ä–∏—Ç—É–∞–ª: –∑–∞–∫—Ä—ã—Ç—å –≥–ª–∞–∑–∞ –∏ —É—Å–ª—ã—à–∞—Ç—å —Å–≤–æ—ë —Å–µ—Ä–¥—Ü–µ."
            ],
            "echo": [
                "üå´ –≠—Ö–æ –Ω–æ—á–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç —Ç–≤–æ–∏ –º—ã—Å–ª–∏, —á—Ç–æ–±—ã —Ç—ã –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª: —Ç–µ–±—è —Å–ª—ã—à–∞—Ç.",
                "üå´ –¢–µ–Ω—å —Ç–≤–æ–∏—Ö —Å–ª–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ, –º—è–≥–∫–æ –∫–∞—Å–∞—è—Å—å –¥—É—à–∏.",
                "üå´ –°–ª—É—à–∞–π —ç—Ö–æ: –æ–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ —Ç—ã –Ω–µ –æ–¥–∏–Ω."
            ],
            "friend": [
                "ü¶á –¢–µ–Ω—å –¥—Ä—É–≥–∞ —Ä—è–¥–æ–º. –î–∞–∂–µ –µ—Å–ª–∏ —Ç—ã –æ–¥–∏–Ω, –∫—Ç–æ-—Ç–æ –∑–¥–µ—Å—å.",
                "ü¶á –ù–µ–≤–∏–¥–∏–º—ã–π —Å–ø—É—Ç–Ω–∏–∫ ‚Äî —Ä—è–¥–æ–º, —Å–ª—É—à–∞–µ—Ç –∏ –ø–æ–Ω–∏–º–∞–µ—Ç.",
                "ü¶á –í —Ç–µ–º–Ω–æ—Ç–µ –µ—Å—Ç—å –∫—Ç–æ-—Ç–æ, –∫—Ç–æ –¥–µ—Ä–∂–∏—Ç —Å —Ç–æ–±–æ–π —Å–≤—è–∑—å."
            ],
            "sphere": [
                "üí† –°—Ñ–µ—Ä–∞ –ø–æ–∫–æ—è ‚Äî –º–∞–ª–µ–Ω—å–∫–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –º—è–≥–∫–æ–π —Ç–∏—à–∏–Ω—ã –≤–Ω—É—Ç—Ä–∏ —Ç–µ–±—è.",
                "üí† –ü—Ä–µ–¥—Å—Ç–∞–≤—å —Å–ø–æ–∫–æ–π–Ω—ã–π –∫—Ä—É–≥ —Å–≤–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –∑–∞—â–∏—â–∞–µ—Ç —Ç–µ–±—è –≤–Ω—É—Ç—Ä–∏.",
                "üí† –°—Ñ–µ—Ä–∞ ‚Äî —Ç–≤–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Å—Ç—Ä–æ–≤ –ø–æ–∫–æ—è —Å—Ä–µ–¥–∏ –±—É—Ä—å –º—ã—Å–ª–µ–π."
            ],
            "labyrinth": [
                "üï∏ –õ–∞–±–∏—Ä–∏–Ω—Ç —Ä–∞–∑—É–º–∞: –ø—Ä–æ—Å–ª–µ–¥–∏ –ø—É—Ç—å —Å–≤–æ–∏—Ö –º—ã—Å–ª–µ–π, –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞—è –∏—Ö.",
                "üï∏ –°–ª–æ–∂–Ω—ã–π –ø—É—Ç—å –º—ã—Å–ª–∏: –ø–æ–∑–≤–æ–ª—å —Å–µ–±–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –µ–≥–æ —Å–ø–æ–∫–æ–π–Ω–æ.",
                "üï∏ –ö–∞–∂–¥—ã–π –∫–æ—Ä–∏–¥–æ—Ä —Ä–∞–∑—É–º–∞ ‚Äî —á–∞—Å—Ç—å —Ç–µ–±—è. –ò—Å—Å–ª–µ–¥—É–π –±–µ–∑ —Å—Ç—Ä–∞—Ö–∞."
            ]
        }
        text = random.choice(options.get(query.data, ["–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫‚Ä¶ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑."]))

    await query.edit_message_text(text=text, reply_markup=InlineKeyboardMarkup(MAIN_KEYBOARD))

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    if "awaiting_input" in context.user_data:
        key = context.user_data["awaiting_input"]
        save_user_data(user_id, key, update.message.text)
        await update.message.reply_text(f"‚úÖ –¢–≤–æ—è –∑–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ {key.replace('_', ' ')}.")
        context.user_data.pop("awaiting_input")

async def health_check(request):
    return web.Response(text="OK", status=200)

async def webhook_handler(request):
    app = request.app["bot_app"]
    data = await request.json()
    update = Update.de_json(data, app.bot)
    await app.process_update(update)
    return web.Response(text="OK", status=200)

async def on_startup(web_app):
    bot_app = web_app["bot_app"]
    await bot_app.initialize()
    await bot_app.start()
    
    if WEBHOOK_URL:
        webhook_path = f"/webhook/{TOKEN}"
        full_url = f"{WEBHOOK_URL}{webhook_path}"
        await bot_app.bot.set_webhook(url=full_url)
        print(f"Webhook set to: {full_url}")
    
    print("Heart of the Night –∑–∞–ø—É—â–µ–Ω...")

async def on_shutdown(web_app):
    bot_app = web_app["bot_app"]
    await bot_app.stop()
    await bot_app.shutdown()

def main():
    if not TOKEN:
        print("Error: TELEGRAM_BOT_TOKEN not set")
        return
    
    bot_app = Application.builder().token(TOKEN).build()
    
    bot_app.add_handler(CommandHandler("start", start))
    bot_app.add_handler(CallbackQueryHandler(handle_button))
    bot_app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    web_app = web.Application()
    web_app["bot_app"] = bot_app
    
    web_app.router.add_get("/", health_check)
    web_app.router.add_get("/health", health_check)
    web_app.router.add_post(f"/webhook/{TOKEN}", webhook_handler)
    
    web_app.on_startup.append(on_startup)
    web_app.on_shutdown.append(on_shutdown)
    
    print(f"Starting server on port {PORT}...")
    web.run_app(web_app, host="0.0.0.0", port=PORT)

if __name__ == "__main__":
    main()
